<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Land Registration System (Drive Edition)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsPDF & html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google API Scripts -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <script>
        // Set worker script for PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Custom Notification Styling */
        .notification {
            position: fixed; top: 20px; right: 20px; padding: 15px 20px;
            border-radius: 8px; color: white; z-index: 6000;
            transform: translateX(150%); transition: transform 0.3s ease-out;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .notification.show { transform: translateX(0); }
        .notification.success { background-color: #10b981; }
        .notification.error { background-color: #ef4444; }
        .notification.info { background-color: #3b82f6; }
        
        /* Loader */
        .loader {
            border: 3px solid #f3f3f3; border-top: 3px solid #3498db;
            border-radius: 50%; width: 20px; height: 20px;
            animation: spin 1s linear infinite; display: inline-block; vertical-align: middle;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .hidden { display: none !important; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .person-card {
            background-color: #f9fafb; border-radius: 8px; padding: 15px;
            margin-bottom: 15px; border: 1px solid #e5e7eb; position: relative;
        }
        .remove-btn { position: absolute; top: 10px; right: 10px; color: #ef4444; cursor: pointer; background: none; border: none; font-size: 18px; }
        
        /* Login & Modal Styles */
        .login-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex; justify-content: center; align-items: center; z-index: 50;
        }
        .login-card { background-color: white; width: 400px; border-radius: 12px; padding: 30px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 600; color: #374151; }
        .form-input { width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; }
        
        /* Upload Area */
        .upload-container {
            background-color: #f8fafc; border: 2px dashed #d1d5db; border-radius: 8px;
            padding: 30px; text-align: center; margin-bottom: 20px; transition: all 0.3;
        }
        .upload-container.dragover { border-color: #3b82f6; background-color: #eff6ff; }
        .file-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 15px; background-color: white; border: 1px solid #e5e7eb;
            border-radius: 6px; margin-bottom: 10px;
        }
        
        /* PDF Viewer Modal */
        #pdfViewerModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.9); z-index: 3000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .pdf-controls {
            background: #333; color: white; padding: 10px 20px; width: 100%;
            display: flex; justify-content: space-between; align-items: center; box-sizing: border-box;
        }
        .pdf-content {
            flex: 1; overflow: auto; width: 100%; display: flex; justify-content: center;
            padding: 20px; background: #525659;
        }
        #pdfCanvas { box-shadow: 0 0 10px rgba(0,0,0,0.5); max-width: 100%; }

        /* Preview Styling */
        .preview-container { padding: 30px; background-color: white; border: 1px solid #e5e7eb; border-radius: 8px; min-height: 500px;}
        .preview-section { margin-bottom: 25px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .preview-title { font-weight: bold; font-size: 18px; color: #1f2937; margin-bottom: 15px; }
        .preview-field { margin-bottom: 10px; display: flex; }
        .preview-label { font-weight: 600; color: #4b5563; min-width: 180px; }
        
        /* Hidden PDF Generation Container */
        #tempPdfGenContainer {
            position: fixed; top: 0; left: -9999px; width: 210mm; background: white; color: black; visibility: visible; z-index: -1; padding: 20px; margin: 0;
        }
        
        /* Location Badge */
        .location-badge {
            display: inline-flex; align-items: center; background-color: #ecfdf5; color: #059669; 
            padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; margin-top: 5px;
        }

        /* Dynamic List Item Styling (Khata/Plot) */
        .list-item-row {
            display: flex; align-items: center; gap: 8px; margin-bottom: 8px; animation: fadeIn 0.3s ease;
        }
        .list-item-row input { flex: 1; }
    </style>
</head>
<body class="bg-gray-100">
    
    <!-- Login Container -->
    <div id="loginContainer" class="login-container">
        <div class="login-card">
            <div class="text-center mb-6">
                <h1 class="text-2xl font-bold text-gray-800"><i class="fas fa-file-contract mr-2"></i>My Registry Record</h1>
                <p class="text-gray-500">Secure Cloud System</p>
                <p class="text-gray-500">by Mohammad Zeeshan</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" id="loginUserId" class="form-input" placeholder="user@example.com" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" id="loginPassword" class="form-input" required>
                </div>
                <div id="loginError" class="text-red-500 text-sm text-center mb-4 hidden"></div>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition">Login</button>
                <button type="button" id="createAccountBtn" class="w-full bg-gray-200 text-gray-700 py-2 rounded-md hover:bg-gray-300 transition mt-3">Create Account</button>
            </form>
        </div>
    </div>

    <!-- Create Account Modal -->
    <div id="createAccountModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-lg w-96">
            <h2 class="text-xl font-bold mb-4">Create Account</h2>
            <form id="createAccountForm">
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" id="newUserId" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" id="newPassword" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Confirm Password</label>
                    <input type="password" id="confirmPassword" class="form-input" required>
                </div>
                <div class="flex gap-2">
                    <button type="button" id="cancelCreateAccount" class="flex-1 bg-gray-300 py-2 rounded">Cancel</button>
                    <button type="submit" class="flex-1 bg-blue-600 text-white py-2 rounded">Create</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Custom Confirmation Modal (Replaces native confirm) -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-[5000] flex items-center justify-center fade-in">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4 transform transition-all scale-100">
            <div class="flex items-center gap-3 mb-4 text-red-600">
                <i class="fas fa-exclamation-triangle text-2xl"></i>
                <h3 class="text-lg font-bold text-gray-800">Confirm Deletion</h3>
            </div>
            <p id="confirmMessage" class="text-gray-600 mb-6">Are you sure you want to proceed? This action cannot be undone.</p>
            <div class="flex justify-end gap-3">
                <button id="confirmCancelBtn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition font-medium">Cancel</button>
                <button id="confirmOkBtn" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition font-medium shadow-md">Yes, Delete</button>
            </div>
        </div>
    </div>

    <!-- PDF Viewer Modal -->
    <div id="pdfViewerModal" class="hidden">
        <div class="pdf-controls">
            <div class="flex items-center gap-4">
                <button id="closePdfModal" class="hover:text-gray-300"><i class="fas fa-times"></i></button>
                <span id="pdfTitle" class="text-sm font-semibold truncate max-w-md">Document.pdf</span>
            </div>
            <div class="flex items-center gap-2">
                <button id="prevPage" class="px-3 py-1 bg-gray-700 rounded hover:bg-gray-600"><i class="fas fa-chevron-left"></i></button>
                <span id="pageInfo" class="text-sm">Page 1 of 1</span>
                <button id="nextPage" class="px-3 py-1 bg-gray-700 rounded hover:bg-gray-600"><i class="fas fa-chevron-right"></i></button>
            </div>
            <button id="downloadCurrentPdf" class="hover:text-blue-400"><i class="fas fa-download"></i> Download</button>
        </div>
        <div class="pdf-content">
            <canvas id="pdfCanvas"></canvas>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <header class="bg-blue-600 text-white shadow-md">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <h1 class="text-xl font-bold"><i class="fas fa-file-contract mr-2"></i>Registry Record</h1>
                <div class="flex items-center gap-4">
                    <span id="connectionStatus" class="text-sm bg-green-500 px-2 py-1 rounded">Online</span>
                    
                    <div id="driveSection" class="hidden flex items-center gap-2 bg-blue-700 px-3 py-1 rounded-full">
                         <span id="driveStatus" class="text-xs"><i class="fab fa-google-drive"></i> Connected</span>
                    </div>
                    <button id="connectDriveBtn" class="text-sm bg-white text-blue-600 px-3 py-1 rounded font-bold hover:bg-gray-100 transition shadow">
                        <i class="fab fa-google-drive"></i> Connect Drive (Required)
                    </button>

                    <div class="flex items-center gap-2 border-l border-blue-500 pl-4">
                        <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center font-bold" id="profileIcon">U</div>
                        <span id="profileName">User</span>
                    </div>
                    <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 px-3 py-1 rounded text-sm"><i class="fas fa-sign-out-alt"></i> Logout</button>
                </div>
            </div>
        </header>

        <main class="container mx-auto px-4 py-6">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex border-b mb-6">
                    <button class="tab-btn px-6 py-2 font-medium text-blue-600 border-b-2 border-blue-600" data-tab="form">
                        <i class="fas fa-edit mr-1"></i> Form
                    </button>
                    <button class="tab-btn px-6 py-2 font-medium text-gray-500 hover:text-blue-600" data-tab="preview">
                        <i class="fas fa-eye mr-1"></i> Preview & Sync
                    </button>
                    <button class="tab-btn px-6 py-2 font-medium text-gray-500 hover:text-blue-600" data-tab="records">
                        <i class="fas fa-database mr-1"></i> Cloud Records
                    </button>
                </div>

                <div id="form-tab" class="tab-content active">
                    <form id="registrationForm">
                        <div class="mb-6">
                            <h2 class="text-lg font-bold text-gray-800 mb-3 border-l-4 border-blue-600 pl-3">Seller Details</h2>
                            <div id="sellersContainer"></div>
                            <button type="button" id="addSellerBtn" class="text-blue-600 hover:text-blue-800 font-medium">
                                <i class="fas fa-plus-circle"></i> Add Seller
                            </button>
                        </div>

                        <div class="mb-6">
                            <h2 class="text-lg font-bold text-gray-800 mb-3 border-l-4 border-green-600 pl-3">Purchaser Details</h2>
                            <div id="purchasersContainer"></div>
                            <button type="button" id="addPurchaserBtn" class="text-green-600 hover:text-green-800 font-medium">
                                <i class="fas fa-plus-circle"></i> Add Purchaser
                            </button>
                        </div>

                        <div class="mb-6">
                            <h2 class="text-lg font-bold text-gray-800 mb-3 border-l-4 border-purple-600 pl-3">Registration Details</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Date</label>
                                    <input type="date" id="registrationDate" class="w-full border p-2 rounded" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Deed Number</label>
                                    <input type="text" id="deedNumber" class="w-full border p-2 rounded" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Mauza Detail</label>
                                    <input type="text" id="mauzaDetail" class="w-full border p-2 rounded" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Block</label>
                                    <select id="block" class="w-full border p-2 rounded" required>
                                        <option value="">Select Block</option>
                                        <option value="Giridih">Giridih</option>
                                        <option value="Dumri">Dumri</option>
                                        <option value="Pirtand">Pirtand</option>
                                        <option value="Bagodar">Bagodar</option>
                                        <option value="Suriya">Suriya</option>
                                        <option value="Gandey">Gandey</option>
                                        <option value="Jamua">Jamua</option>
                                        <option value="Deori">Deori</option>
                                        <option value="Tisri">Tisri</option>
                                        <option value="Dhanwar">Dhanwar</option>
                                        <option value="Gawan">Gawan</option>
                                        <option value="Bengabad">Bengabad</option>
                                        <option value="Birni">Birni</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Khata(s)</label>
                                    <div id="khataContainer"></div>
                                    <button type="button" id="addKhataBtn" class="text-xs text-blue-600 mt-1 hover:underline">+ Add Khata</button>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Plot(s)</label>
                                    <div id="plotContainer"></div>
                                    <button type="button" id="addPlotBtn" class="text-xs text-blue-600 mt-1 hover:underline">+ Add Plot</button>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Area</label>
                                    <input type="text" id="area" class="w-full border p-2 rounded" required>
                                </div>
                            </div>
                        </div>

                        <div class="mb-6">
                            <h2 class="text-lg font-bold text-gray-800 mb-3 border-l-4 border-orange-600 pl-3">Mutation Details</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Case Number</label>
                                    <input type="text" id="caseNumber" class="w-full border p-2 rounded" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Year</label>
                                    <input type="number" id="mutationYear" class="w-full border p-2 rounded" required>
                                </div>
                            </div>
                        </div>

                        <div class="mb-6">
                            <h2 class="text-lg font-bold text-gray-800 mb-3 border-l-4 border-red-600 pl-3">GPS Location</h2>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <input type="text" id="latitude" class="border p-2 rounded" placeholder="Latitude">
                                <input type="text" id="longitude" class="border p-2 rounded" placeholder="Longitude">
                                <div class="flex gap-2 flex-wrap">
                                    <button type="button" id="getCurrentLocationBtn" class="bg-blue-600 text-white px-3 py-2 rounded flex-1 text-sm min-w-[100px]"><i class="fas fa-location-arrow"></i> Get</button>
                                    <button type="button" id="saveLocationBtn" class="bg-green-600 text-white px-3 py-2 rounded flex-1 text-sm min-w-[100px]"><i class="fas fa-save"></i> Save</button>
                                    <button type="button" id="viewMapBtn" class="bg-red-500 text-white px-3 py-2 rounded flex-1 text-sm min-w-[100px]"><i class="fas fa-map-marked-alt"></i> Map</button>
                                </div>
                            </div>
                            <div id="locationStatus" class="mt-2 text-sm text-gray-500"></div>
                        </div>

                        <div class="mb-6">
                            <h2 class="text-lg font-bold text-gray-800 mb-3 border-l-4 border-indigo-600 pl-3">Upload PDF (Direct to Drive)</h2>
                            <div class="upload-container" id="uploadContainer">
                                <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-2"></i>
                                <p class="text-gray-600 mb-2">Drag & drop PDF files here</p>
                                <p class="text-xs text-blue-500 font-bold mb-2">*Must Connect Google Drive First*</p>
                                <button type="button" id="uploadBtn" class="bg-blue-600 text-white px-4 py-2 rounded text-sm">Select Files</button>
                                <input type="file" id="fileInput" class="hidden" accept=".pdf" multiple>
                            </div>
                            <div id="fileList" class="space-y-2"></div>
                        </div>

                        <div class="flex justify-end gap-3 mt-8 border-t pt-4">
                            <button type="button" id="saveLocalBtn" class="bg-gray-600 text-white px-6 py-2 rounded hover:bg-gray-700">
                                <i class="fas fa-save mr-1"></i> Save to Cloud
                            </button>
                            <button type="button" id="previewBtn" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
                                <i class="fas fa-eye mr-1"></i> Preview
                            </button>
                            <button type="button" id="syncDriveBtnForm" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 hidden">
                                <i class="fab fa-google-drive mr-1"></i> Sync to Drive
                            </button>
                        </div>
                    </form>
                </div>

                <div id="preview-tab" class="tab-content">
                    <div class="flex justify-center">
                        <div id="previewContent" class="preview-container w-full max-w-4xl">
                            <div class="text-center text-gray-400 py-20">Generate Preview</div>
                        </div>
                    </div>
                    <div class="flex justify-center gap-3 mt-6">
                        <button id="downloadPdfBtn" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
                            <i class="fas fa-download"></i> Download PDF
                        </button>
                        <button id="syncFromPreviewBtn" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 hidden">
                            <i class="fab fa-google-drive mr-1"></i> Sync to Drive
                        </button>
                    </div>
                </div>

                <div id="records-tab" class="tab-content">
                    <div class="mb-4 flex flex-col md:flex-row gap-4 bg-gray-50 p-4 rounded">
                        <input type="text" id="quickSearch" class="border p-2 rounded md:w-1/3" placeholder="Search (Name, Deed)...">
                        <button id="searchBtn" class="bg-blue-600 text-white px-4 py-2 rounded">Search</button>
                        <button id="clearSearchBtn" class="bg-gray-400 text-white px-4 py-2 rounded">Clear</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-200">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-4 py-2 text-left text-sm font-bold text-gray-700">Date</th>
                                    <th class="px-4 py-2 text-left text-sm font-bold text-gray-700">Deed No.</th>
                                    <th class="px-4 py-2 text-left text-sm font-bold text-gray-700">Sellers</th>
                                    <th class="px-4 py-2 text-left text-sm font-bold text-gray-700">Purchasers</th>
                                    <th class="px-4 py-2 text-left text-sm font-bold text-gray-700">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="recordsTableBody" class="text-sm text-gray-600">
                                <!-- Cloud Data Here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
        
        <footer class="text-center py-6 text-gray-500 text-sm mt-8 border-t">
            <p>&copy; 2026 Land Registration Record System.</p>
            <p>&copy; Created & Managed By Mohammad Zeeshan.</p>
        </footer>
    </div>

    <div id="tempPdfGenContainer"></div>

    <!-- MAIN SCRIPT MODULE -->
    <script type="module">
        // --- 1. FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged,
            updateProfile 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            updateDoc, 
            deleteDoc, 
            doc, 
            getDoc,
            query, 
            where,
            orderBy 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDe2gaEi9jj8ApEffNZHL5fkK1T_CGJHEw",
            authDomain: "loginmyweb-33ccd.firebaseapp.com",
            projectId: "loginmyweb-33ccd",
            storageBucket: "loginmyweb-33ccd.firebasestorage.app",
            messagingSenderId: "873287193140",
            appId: "1:873287193140:web:e35048492ebbf62df83061"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- USER CONFIGURATION ---
        const CLIENT_ID = '746575158694-32jbpos6nbk0iqisjtsdbe6gvug4aq91.apps.googleusercontent.com';
        const API_KEY = 'AQ.Ab8RN6L1QD9Gl4hl-j50IzR-RC1DPKj8JFa2WMDP-4c89Mc1yg'; 
        
        const SCOPES = 'https://www.googleapis.com/auth/drive';
        const TARGET_DRIVE_FOLDER_ID = '1i8kzFHqpjfR8q28NIwtXmcl0zVaFlvPy'; 

        // --- GLOBAL STATE ---
        let currentUser = null;
        let uploadedFiles = []; 
        let currentRecordId = null; 
        let isDriveConnected = false;
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let registrationData = null;
        let savedLocation = { lat: '', lng: '' }; // Temporary state for "Save Location" button

        // --- GLOBAL HELPER FOR MAP ---
        // Expose this to window so dynamic HTML can call it
        window.openMap = (lat, lng) => {
            if(lat && lng) window.open(`https://www.google.com/maps?q=${lat},${lng}`, '_blank');
            else showNotification('Location coordinates missing', 'error');
        };

        // --- EXPOSE FUNCTIONS TO WINDOW ---
        
        // 1. Custom Confirmation Logic
        let confirmCallback = null;

        function showCustomConfirm(message, onConfirm) {
            const modal = document.getElementById('confirmModal');
            document.getElementById('confirmMessage').innerText = message;
            modal.classList.remove('hidden');
            confirmCallback = onConfirm;
        }

        function setupConfirmModal() {
            document.getElementById('confirmCancelBtn').addEventListener('click', () => {
                document.getElementById('confirmModal').classList.add('hidden');
                confirmCallback = null;
            });
            document.getElementById('confirmOkBtn').addEventListener('click', () => {
                document.getElementById('confirmModal').classList.add('hidden');
                if (confirmCallback) confirmCallback();
                confirmCallback = null;
            });
        }

        // 2. File Remove Logic (Updated to use Custom Confirm)
        window.removeFile = async (id) => {
            const file = uploadedFiles.find(f => f.id === id);
            const fileName = file ? file.name : 'this file';

            showCustomConfirm(`Remove "${fileName}" from Google Drive?`, async () => {
                try {
                    if(!isDriveConnected) return showNotification('Connect Drive first', 'error');
                    await driveRequest(`https://www.googleapis.com/drive/v3/files/${id}`, 'DELETE');
                    uploadedFiles = uploadedFiles.filter(f => f.id !== id);
                    renderFileList();
                    showNotification('File deleted from Drive', 'success');
                } catch (e) {
                    showNotification('Error removing file: ' + e.message, 'error');
                }
            });
        };

        window.viewPdfInModal = async (id) => {
            try {
                if(!isDriveConnected) return showNotification('Connect Drive first', 'error');
                
                const modal = document.getElementById('pdfViewerModal');
                const canvas = document.getElementById('pdfCanvas');
                const ctx = canvas.getContext('2d');
                modal.classList.remove('hidden');
                
                const response = await driveRequest(`https://www.googleapis.com/drive/v3/files/${id}?alt=media`, 'GET', null, true);
                
                if (!response.ok) throw new Error('Failed to download PDF');
                
                const blob = await response.blob();
                const typedarray = await blob.arrayBuffer();
                
                document.getElementById('pdfTitle').innerText = uploadedFiles.find(f => f.id === id)?.name || 'Document.pdf';
                if (currentPdfBlobUrl) URL.revokeObjectURL(currentPdfBlobUrl);
                currentPdfBlobUrl = URL.createObjectURL(blob);
                
                pdfDoc = await pdfjsLib.getDocument(typedarray).promise;
                document.getElementById('pageInfo').innerText = `Page ${pageNum} of ${pdfDoc.numPages}`;
                renderPage(pageNum);
            } catch (e) {
                console.error(e);
                showNotification('Error loading PDF: ' + e.message, 'error');
                closePdfModal();
            }
        };

        window.downloadFile = async (id) => {
            try {
                if(!isDriveConnected) return showNotification('Connect Drive first', 'error');
                
                const response = await driveRequest(`https://www.googleapis.com/drive/v3/files/${id}?alt=media`, 'GET', null, true);
                if (!response.ok) throw new Error('Download failed');
                
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const fileName = uploadedFiles.find(f => f.id === id)?.name || 'download.pdf';
                
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (e) {
                showNotification('Error downloading file', 'error');
            }
        };

        window.viewRecord = async (id) => {
            const docRef = doc(db, "records", id);
            const docSnap = await getDoc(docRef);
            
            if (docSnap.exists()) {
                const data = { id: docSnap.id, ...docSnap.data() };
                registrationData = data;
                uploadedFiles = data.documents || [];
                generatePreview();
                switchTab('preview');
            } else {
                showNotification('Record not found', 'error');
            }
        };

        window.editRecord = async (id) => {
            const docRef = doc(db, "records", id);
            const docSnap = await getDoc(docRef);
            
            if (docSnap.exists()) {
                const data = { id: docSnap.id, ...docSnap.data() };
                currentRecordId = data.id; 
                switchTab('form');

                document.getElementById('registrationDate').value = data.regDetails.date;
                document.getElementById('deedNumber').value = data.regDetails.deedNo;
                document.getElementById('mauzaDetail').value = data.regDetails.mauza;
                document.getElementById('block').value = data.regDetails.block;
                document.getElementById('area').value = data.regDetails.area;
                document.getElementById('caseNumber').value = data.mutation.caseNo;
                document.getElementById('mutationYear').value = data.mutation.year;
                
                // Handle GPS inputs
                document.getElementById('latitude').value = data.gps.lat;
                document.getElementById('longitude').value = data.gps.lng;
                savedLocation = { lat: data.gps.lat, lng: data.gps.lng };
                updateLocationStatus(true);

                // Handle Sellers
                document.getElementById('sellersContainer').innerHTML = '';
                data.sellers.forEach(s => {
                    addPersonCard('sellersContainer', 'seller');
                    const last = document.querySelector('#sellersContainer .person-card:last-child');
                    last.querySelector('.seller-name').value = s.name;
                    last.querySelector('.seller-father').value = s.father;
                    last.querySelector('.seller-mobile').value = s.mobile;
                    last.querySelector('.seller-address').value = s.address;
                });

                // Handle Purchasers
                document.getElementById('purchasersContainer').innerHTML = '';
                data.purchasers.forEach(p => {
                    addPersonCard('purchasersContainer', 'purchaser');
                    const last = document.querySelector('#purchasersContainer .person-card:last-child');
                    last.querySelector('.purchaser-name').value = p.name;
                    last.querySelector('.purchaser-father').value = p.father;
                    last.querySelector('.purchaser-mobile').value = p.mobile;
                    last.querySelector('.purchaser-address').value = p.address;
                });

                // Handle Khatas (UPDATED FOR REMOVE BUTTON)
                document.getElementById('khataContainer').innerHTML = '';
                data.regDetails.khatas.forEach(k => {
                    addKhataWithValue(k);
                });

                // Handle Plots (UPDATED FOR REMOVE BUTTON)
                document.getElementById('plotContainer').innerHTML = '';
                data.regDetails.plots.forEach(p => {
                    addPlotWithValue(p);
                });

                uploadedFiles = data.documents || []; 
                renderFileList();
                
                showNotification("Record Loaded.", "info");
            }
        };

        // 3. Delete Record Logic (Updated to use Custom Confirm)
        window.deleteRecord = async (id) => {
            showCustomConfirm('Are you sure you want to delete this record? This cannot be undone.', async () => {
                try {
                    await deleteDoc(doc(db, "records", id));
                    loadRecords();
                    showNotification('Record deleted successfully', 'success');
                } catch (error) {
                    console.error(error);
                    showNotification('Error deleting record: ' + error.message, 'error');
                }
            });
        };

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Set defaults
            document.getElementById('registrationDate').valueAsDate = new Date();
            document.getElementById('mutationYear').value = new Date().getFullYear();
            addPersonCard('sellersContainer', 'seller');
            addPersonCard('purchasersContainer', 'purchaser');
            addKhata(); 
            addPlot(); 
            
            setupEventListeners();
            setupConfirmModal(); // Initialize modal logic

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    document.getElementById('loginContainer').classList.add('hidden');
                    document.getElementById('mainApp').classList.remove('hidden');
                    document.getElementById('profileName').innerText = user.email;
                    document.getElementById('profileIcon').innerText = user.email.charAt(0).toUpperCase();
                    loadRecords();
                    initializeGoogleAPI();
                } else {
                    currentUser = null;
                    document.getElementById('loginContainer').classList.remove('hidden');
                    document.getElementById('mainApp').classList.add('hidden');
                }
            });
        });

        // --- AUTH LOGIC ---
        const handleLogin = async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginUserId').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showNotification('Login successful', 'success');
            } catch (error) {
                errorDiv.innerText = error.message;
                errorDiv.classList.remove('hidden');
            }
        };

        const handleCreateAccount = async (e) => {
            e.preventDefault();
            const email = document.getElementById('newUserId').value;
            const password = document.getElementById('newPassword').value;
            const confirm = document.getElementById('confirmPassword').value;
            if (password !== confirm) return showNotification('Passwords do not match', 'error');
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                document.getElementById('createAccountModal').classList.add('hidden');
                showNotification('Account created!', 'success');
            } catch (error) { showNotification(error.message, 'error'); }
        };

        const handleLogout = () => { signOut(auth).then(() => showNotification('Logged out', 'info')); };

        // --- GPS HELPER FUNCTIONS ---
        function updateLocationStatus(isSaved) {
            const statusDiv = document.getElementById('locationStatus');
            if (isSaved) {
                statusDiv.innerHTML = `<span class="location-badge"><i class="fas fa-check-circle mr-1"></i> Location Saved (${savedLocation.lat}, ${savedLocation.lng})</span>`;
            } else {
                statusDiv.innerHTML = '';
            }
        }

        const handleSaveLocation = () => {
            const lat = document.getElementById('latitude').value;
            const lng = document.getElementById('longitude').value;
            
            if (!lat || !lng) {
                showNotification('Please enter or get coordinates first', 'error');
                return;
            }
            
            savedLocation = { lat, lng };
            updateLocationStatus(true);
            showNotification('Coordinates saved for this record', 'success');
        }

        // --- GOOGLE DRIVE HELPER ---
        // Centralized function to handle Drive API requests using Fetch
        async function driveRequest(url, method = 'GET', body = null, isBinary = false) {
            const token = gapi.client.getToken().access_token;
            const headers = { 'Authorization': `Bearer ${token}` };
            
            if (body instanceof FormData) {
                // FormData sets its own Content-Type with boundary
            } else if (body) {
                headers['Content-Type'] = 'application/json';
            }

            const options = { method, headers };
            if (body) options.body = body;

            const response = await fetch(url, options);
            
            if (!response.ok && !isBinary) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error?.message || response.statusText);
            }
            return response;
        }

        function initializeGoogleAPI() {
            gapi.load('client', async () => {
                await gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                });
                gapiInited = true;
            });
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (tokenResponse) => {
                    if (tokenResponse && tokenResponse.access_token) {
                        isDriveConnected = true;
                        updateDriveUI(true);
                    }
                },
            });
            gisInited = true;
        }

        function updateDriveUI(connected) {
            document.getElementById('connectDriveBtn').classList.toggle('hidden', connected);
            document.getElementById('driveSection').classList.toggle('hidden', !connected);
            document.getElementById('syncDriveBtnForm').classList.toggle('hidden', !connected);
            document.getElementById('syncFromPreviewBtn').classList.toggle('hidden', !connected);
        }
        function handleAuthClick() { 
            if (tokenClient) tokenClient.requestAccessToken({prompt: ''}); 
        }

        // --- DRIVE FILE OPERATIONS ---

        async function uploadFileToDriveImmediate(file) {
            if (!isDriveConnected) throw new Error("Please Connect Drive first.");

            const metadata = {
                'name': file.name,
                'mimeType': 'application/pdf'
            };

            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', file);

            const response = await driveRequest('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name', 'POST', form);
            const data = await response.json();
            return { id: data.id, name: data.name };
        }

        function setupEventListeners() {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.addEventListener('click', (e) => switchTab(e.target.dataset.tab)));
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.getElementById('connectDriveBtn').addEventListener('click', handleAuthClick);
            document.getElementById('createAccountBtn').addEventListener('click', () => document.getElementById('createAccountModal').classList.remove('hidden'));
            document.getElementById('cancelCreateAccount').addEventListener('click', () => document.getElementById('createAccountModal').classList.add('hidden'));
            document.getElementById('createAccountForm').addEventListener('submit', handleCreateAccount);
            document.getElementById('addSellerBtn').addEventListener('click', () => addPersonCard('sellersContainer', 'seller'));
            document.getElementById('addPurchaserBtn').addEventListener('click', () => addPersonCard('purchasersContainer', 'purchaser'));
            document.getElementById('addKhataBtn').addEventListener('click', addKhata);
            document.getElementById('addPlotBtn').addEventListener('click', addPlot);
            document.getElementById('getCurrentLocationBtn').addEventListener('click', getCurrentLocation);
            document.getElementById('saveLocationBtn').addEventListener('click', handleSaveLocation); 
            document.getElementById('viewMapBtn').addEventListener('click', openGoogleMap);
            document.getElementById('uploadBtn').addEventListener('click', () => document.getElementById('fileInput').click());
            document.getElementById('fileInput').addEventListener('change', handleFileSelect);
            const dropZone = document.getElementById('uploadContainer');
            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
            dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
            dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); handleFileUpload(e.dataTransfer.files); });
            document.getElementById('saveLocalBtn').addEventListener('click', saveRecord);
            document.getElementById('previewBtn').addEventListener('click', () => { generatePreview(); switchTab('preview'); });
            document.getElementById('syncDriveBtnForm').addEventListener('click', syncRecord);
            document.getElementById('syncFromPreviewBtn').addEventListener('click', syncRecord);
            document.getElementById('downloadPdfBtn').addEventListener('click', downloadReportPDF);
            document.getElementById('searchBtn').addEventListener('click', performSearch);
            document.getElementById('clearSearchBtn').addEventListener('click', () => { document.getElementById('quickSearch').value = ''; loadRecords(); });
            document.getElementById('closePdfModal').addEventListener('click', closePdfModal);
            document.getElementById('prevPage').addEventListener('click', () => renderPdfPage(-1));
            document.getElementById('nextPage').addEventListener('click', () => renderPdfPage(1));
            document.getElementById('downloadCurrentPdf').addEventListener('click', downloadCurrentPdf);
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => {
                el.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
                el.classList.add('text-gray-500');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');
            const activeBtn = document.querySelector(`.tab-btn[data-tab="${tabName}"]`);
            activeBtn.classList.remove('text-gray-500');
            activeBtn.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
        }

        function addPersonCard(containerId, type) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = 'person-card fade-in';
            div.innerHTML = `
                <button type="button" class="remove-btn" onclick="this.parentElement.remove();"><i class="fas fa-times-circle"></i></button>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="text-xs font-bold text-gray-500">Name</label><input type="text" class="w-full border p-1 rounded ${type}-name" required></div>
                    <div><label class="text-xs font-bold text-gray-500">Father/Husband</label><input type="text" class="w-full border p-1 rounded ${type}-father" required></div>
                    <div><label class="text-xs font-bold text-gray-500">Mobile</label><input type="tel" class="w-full border p-1 rounded ${type}-mobile" pattern="[0-9]{10}" title="10 digit mobile number" required></div>
                    <div><label class="text-xs font-bold text-gray-500">Address</label><input type="text" class="w-full border p-1 rounded ${type}-address" required></div>
                </div>`;
            container.appendChild(div);
        }
        
        // --- UPDATED KHATA FUNCTIONS WITH REMOVE BUTTON ---
        function addKhataWithValue(val = '') {
            const container = document.getElementById('khataContainer');
            const div = document.createElement('div');
            div.className = 'list-item-row';
            div.innerHTML = `
                <input type="text" class="khata-input w-full border p-1 rounded" placeholder="Khata No" value="${val}" required>
                <button type="button" class="text-red-500 hover:text-red-700 px-2 py-1 bg-red-50 rounded border border-red-200" onclick="this.parentElement.remove()" title="Remove">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            container.appendChild(div);
        }

        function addKhata() {
            addKhataWithValue('');
        }

        // --- UPDATED PLOT FUNCTIONS WITH REMOVE BUTTON ---
        function addPlotWithValue(val = '') {
            const container = document.getElementById('plotContainer');
            const div = document.createElement('div');
            div.className = 'list-item-row';
            div.innerHTML = `
                <input type="text" class="plot-input w-full border p-1 rounded" placeholder="Plot No" value="${val}" required>
                <button type="button" class="text-red-500 hover:text-red-700 px-2 py-1 bg-red-50 rounded border border-red-200" onclick="this.parentElement.remove()" title="Remove">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            container.appendChild(div);
        }

        function addPlot() {
            addPlotWithValue('');
        }

        function getCurrentLocation() {
            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    const lat = pos.coords.latitude.toFixed(6);
                    const lng = pos.coords.longitude.toFixed(6);
                    document.getElementById('latitude').value = lat;
                    document.getElementById('longitude').value = lng;
                    savedLocation = { lat, lng }; // Auto-save on get
                    updateLocationStatus(true);
                    showNotification('Location found and saved', 'success');
                }, () => {
                    showNotification('Failed to get location', 'error');
                });
            }
        }
        function openGoogleMap() {
            const lat = document.getElementById('latitude').value;
            const lng = document.getElementById('longitude').value;
            if(lat && lng) window.open(`https://www.google.com/maps?q=${lat},${lng}`, '_blank');
            else showNotification('No coordinates to show', 'error');
        }
        
        async function handleFileUpload(files) {
            if(!files || !files.length) return;
            
            if(!isDriveConnected) {
                showNotification('Please Connect Google Drive First!', 'error');
                document.getElementById('connectDriveBtn').classList.add('animate-pulse'); 
                setTimeout(() => document.getElementById('connectDriveBtn').classList.remove('animate-pulse'), 2000);
                return;
            }

            for(const file of files) {
                if(file.type !== 'application/pdf') {
                    showNotification(`Skipped ${file.name}: Only PDF allowed`, 'info');
                    continue;
                }
                
                try {
                    const btn = document.getElementById('uploadBtn');
                    const originalText = btn.innerHTML;
                    btn.innerHTML = `<span class="loader mr-2"></span> Uploading ${file.name}...`;
                    
                    const result = await uploadFileToDriveImmediate(file);
                    uploadedFiles.push({ id: result.id, name: result.name });
                    renderFileList();
                    showNotification(`${file.name} uploaded to Drive`, 'success');
                    
                    btn.innerHTML = originalText;
                } catch (e) {
                    console.error(e);
                    showNotification('Upload failed: ' + e.message, 'error');
                }
            }
        }
        function handleFileSelect(e) { handleFileUpload(e.target.files); e.target.value = ''; }
        
        function renderFileList() {
            const container = document.getElementById('fileList');
            container.innerHTML = '';
            uploadedFiles.forEach(file => {
                const div = document.createElement('div');
                div.className = 'file-item';
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <i class="fas fa-file-pdf text-red-500 text-xl"></i>
                        <div>
                            <div class="font-medium text-gray-700">${file.name}</div>
                            <div class="text-xs text-green-600"><i class="fab fa-google-drive"></i> Stored on Drive</div>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button type="button" onclick="window.viewPdfInModal('${file.id}')" class="text-blue-500 hover:bg-blue-50 p-1 rounded" title="View"><i class="fas fa-eye"></i></button>
                        <button type="button" onclick="window.downloadFile('${file.id}')" class="text-green-500 hover:bg-green-50 p-1 rounded" title="Download"><i class="fas fa-download"></i></button>
                        <button type="button" onclick="window.removeFile('${file.id}')" class="text-red-500 hover:bg-red-50 p-1 rounded" title="Remove"><i class="fas fa-trash"></i></button>
                    </div>`;
                container.appendChild(div);
            });
        }

        // PDF Viewer State
        let pdfDoc = null, pageNum = 1, pageRendering = false, pageNumPending = null, currentPdfBlobUrl = null, currentPdfName = '';
        function renderPage(num) {
            pageRendering = true;
            const canvas = document.getElementById('pdfCanvas');
            const ctx = canvas.getContext('2d');
            pdfDoc.getPage(num).then(page => {
                const viewport = page.getViewport({scale: 1.2});
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                const renderContext = { canvasContext: ctx, viewport: viewport };
                const renderTask = page.render(renderContext);
                renderTask.promise.then(() => {
                    pageRendering = false;
                    if(pageNumPending !== null) { renderPage(pageNumPending); pageNumPending = null; }
                });
            });
            document.getElementById('pageInfo').innerText = `Page ${num} of ${pdfDoc.numPages}`;
            document.getElementById('prevPage').disabled = num <= 1;
            document.getElementById('nextPage').disabled = num >= pdfDoc.numPages;
        }
        function renderPdfPage(offset) {
            if(!pdfDoc) return;
            if(pageRendering) pageNumPending = pageNum + offset;
            else { pageNum += offset; renderPage(pageNum); }
        }
        function closePdfModal() {
            document.getElementById('pdfViewerModal').classList.add('hidden');
            pdfDoc = null; pageNum = 1;
            if(currentPdfBlobUrl) { URL.revokeObjectURL(currentPdfBlobUrl); currentPdfBlobUrl = null; }
        }
        function downloadCurrentPdf() {
            if(currentPdfBlobUrl) {
                const a = document.createElement('a');
                a.href = currentPdfBlobUrl; a.download = currentPdfName;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
            }
        }

        // --- CLOUD SYNC (FIRESTORE) ---

        function collectFormData() {
            const sellers = []; document.querySelectorAll('#sellersContainer .person-card').forEach(c => {
                sellers.push({
                    name: c.querySelector('.seller-name').value,
                    father: c.querySelector('.seller-father').value,
                    mobile: c.querySelector('.seller-mobile').value,
                    address: c.querySelector('.seller-address').value
                });
            });
            const purchasers = []; document.querySelectorAll('#purchasersContainer .person-card').forEach(c => {
                purchasers.push({
                    name: c.querySelector('.purchaser-name').value,
                    father: c.querySelector('.purchaser-father').value,
                    mobile: c.querySelector('.purchaser-mobile').value,
                    address: c.querySelector('.purchaser-address').value
                });
            });
            const khatas = Array.from(document.querySelectorAll('.khata-input')).map(i => i.value).filter(v => v);
            const plots = Array.from(document.querySelectorAll('.plot-input')).map(i => i.value).filter(v => v);
            
            // Use savedLocation if set, otherwise fallback to inputs
            const latVal = savedLocation.lat || document.getElementById('latitude').value;
            const lngVal = savedLocation.lng || document.getElementById('longitude').value;
            
            return {
                userId: currentUser.uid,
                userEmail: currentUser.email,
                date: new Date().toISOString(),
                sellers,
                purchasers,
                regDetails: {
                    date: document.getElementById('registrationDate').value,
                    deedNo: document.getElementById('deedNumber').value,
                    mauza: document.getElementById('mauzaDetail').value,
                    block: document.getElementById('block').value,
                    khatas, plots, area: document.getElementById('area').value
                },
                mutation: {
                    caseNo: document.getElementById('caseNumber').value,
                    year: document.getElementById('mutationYear').value
                },
                gps: {
                    lat: latVal,
                    lng: lngVal
                },
                documents: uploadedFiles, 
                driveFolderId: null
            };
        }

        // --- HELPER TO RESET FORM FOR FRESH ENTRY ---
        function resetFormForFreshEntry() {
            // 1. Reset Standard Inputs
            document.getElementById('registrationForm').reset();

            // 2. Reset Date Defaults
            document.getElementById('registrationDate').valueAsDate = new Date();
            document.getElementById('mutationYear').value = new Date().getFullYear();

            // 3. Clear Dynamic Lists and re-add defaults
            document.getElementById('sellersContainer').innerHTML = '';
            addPersonCard('sellersContainer', 'seller');

            document.getElementById('purchasersContainer').innerHTML = '';
            addPersonCard('purchasersContainer', 'purchaser');

            document.getElementById('khataContainer').innerHTML = '';
            addKhata();

            document.getElementById('plotContainer').innerHTML = '';
            addPlot();

            // 4. Clear File Lists and Arrays
            uploadedFiles = [];
            renderFileList();

            // 5. Reset State Variables
            currentRecordId = null;
            registrationData = null;
            savedLocation = { lat: '', lng: '' };

            // 6. Clear UI Extras
            updateLocationStatus(false);
        }

        async function saveRecord() {
            const required = document.querySelectorAll('#registrationForm [required]');
            let valid = true; required.forEach(f => { if(!f.value) valid = false; });
            if(!valid) return showNotification('Fill all required fields', 'error');

            const data = collectFormData();
            
            try {
                if (currentRecordId) {
                    // --- UPDATE EXISTING RECORD ---
                    await updateDoc(doc(db, "records", currentRecordId), data);
                    showNotification('Record updated in Cloud', 'success');
                    // Optional: Do not reset form on update, just go to records to verify
                } else {
                    // --- CREATE NEW RECORD ---
                    const docRef = await addDoc(collection(db, "records"), data);
                    // currentRecordId = docRef.id; // REMOVED THIS TO ALLOW FRESH ENTRY
                    showNotification('Record saved to Cloud', 'success');
                    
                    // --- AUTO RESET LOGIC ---
                    resetFormForFreshEntry();
                }
                
                loadRecords();
                switchTab('records');

            } catch (error) {
                console.error(error);
                showNotification('Error saving to Cloud: ' + error.message, 'error');
            }
        }

        async function loadRecords(filter = '') {
            const tbody = document.getElementById('recordsTableBody');
            tbody.innerHTML = '';
            
            try {
                const q = query(collection(db, "records"), where("userId", "==", currentUser.uid));
                const querySnapshot = await getDocs(q);

                let recordsData = [];
                querySnapshot.forEach((doc) => {
                    recordsData.push({ id: doc.id, ...doc.data() });
                });

                if (filter) {
                    const lower = filter.toLowerCase();
                    recordsData = recordsData.filter(r => 
                        r.regDetails.deedNo.toLowerCase().includes(lower) ||
                        r.sellers.some(s => s.name.toLowerCase().includes(lower)) ||
                        r.purchasers.some(p => p.name.toLowerCase().includes(lower))
                    );
                }

                recordsData.sort((a, b) => new Date(b.date) - new Date(a.date));

                recordsData.forEach(r => {
                    const tr = document.createElement('tr');
                    tr.className = 'border-b hover:bg-gray-50';
                    tr.dataset.id = r.id; 
                    tr.innerHTML = `
                        <td class="px-4 py-2">${r.regDetails.date}</td>
                        <td class="px-4 py-2 font-medium">${r.regDetails.deedNo}</td>
                        <td class="px-4 py-2">${r.sellers.map(s => s.name).join(', ')}</td>
                        <td class="px-4 py-2">${r.purchasers.map(p => p.name).join(', ')}</td>
                        <td class="px-4 py-2 flex gap-2">
                            <button onclick="window.viewRecord('${r.id}')" class="text-blue-600 hover:underline" title="View"><i class="fas fa-eye"></i></button>
                            <button onclick="window.editRecord('${r.id}')" class="text-yellow-600 hover:underline" title="Edit"><i class="fas fa-edit"></i></button>
                            <button onclick="window.deleteRecord('${r.id}')" class="text-red-600 hover:underline" title="Delete"><i class="fas fa-trash"></i></button>
                        </td>`;
                    tbody.appendChild(tr);
                });

            } catch (error) {
                console.error(error);
                showNotification('Error loading records', 'error');
            }
        }

        function performSearch() { loadRecords(document.getElementById('quickSearch').value); }

        // --- PDF GENERATION & PREVIEW ---

        async function generatePdfBlob(data) {
            const recordData = data || registrationData;
            if(!recordData) return Promise.reject("No data");
            const tempContainer = document.getElementById('tempPdfGenContainer');
            
            tempContainer.innerHTML = `
                <div style="font-family: 'Arial', sans-serif; padding: 20px; color: #000; line-height: 1.4; width: 100%; box-sizing: border-box;">
                    <div style="text-align: center; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 20px;">
                        <h1 style="margin: 0; font-size: 20px; color: #000; font-weight: bold;">Land Registration Record</h1>
                        <p style="margin: 10px 0 0; font-size: 12px; color: #555;">Generated: ${new Date().toLocaleString()}</p>
                        <p style="margin: 0; font-size: 12px; color: #555;">Email: ${recordData.userEmail || 'N/A'}</p>
                    </div>
                    <div style="margin-bottom: 25px;">
                        <h3 style="margin: 0 0 10px; font-size: 16px; background: #f3f4f6; padding: 8px; border-left: 5px solid #3b82f6;">Seller(s)</h3>
                        ${recordData.sellers.map((s, i) => `
                            <div style="margin-bottom: 12px; padding: 8px; border: 1px solid #e5e7eb; background: #fff;">
                                <div style="font-weight: bold; font-size: 14px; margin-bottom: 4px;">${i+1}. ${s.name}</div>
                                <div style="font-size: 12px; color: #555;">
                                    <div>Father/Husband: ${s.father}</div>
                                    <div>Mobile: ${s.mobile}</div>
                                    <div>Address: ${s.address}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div style="margin-bottom: 25px;">
                        <h3 style="margin: 0 0 10px; font-size: 16px; background: #f3f4f6; padding: 8px; border-left: 5px solid #10b981;">Purchaser(s)</h3>
                        ${recordData.purchasers.map((p, i) => `
                            <div style="margin-bottom: 12px; padding: 8px; border: 1px solid #e5e7eb; background: #fff;">
                                <div style="font-weight: bold; font-size: 14px; margin-bottom: 4px;">${i+1}. ${p.name}</div>
                                <div style="font-size: 12px; color: #555;">
                                    <div>Father/Husband: ${p.father}</div>
                                    <div>Mobile: ${p.mobile}</div>
                                    <div>Address: ${p.address}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div style="margin-bottom: 25px;">
                        <h3 style="margin: 0 0 10px; font-size: 16px; background: #f3f4f6; padding: 8px; border-left: 5px solid #8b5cf6;">Registration Details</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 12px;">
                            <div><strong>Deed Number:</strong> ${recordData.regDetails.deedNo}</div>
                            <div><strong>Date:</strong> ${recordData.regDetails.date}</div>
                            <div><strong>Mauza:</strong> ${recordData.regDetails.mauza}</div>
                            <div><strong>Block:</strong> ${recordData.regDetails.block}</div>
                            <div><strong>Area:</strong> ${recordData.regDetails.area}</div>
                            <div><strong>Khatas:</strong> ${recordData.regDetails.khatas.join(', ')}</div>
                            <div><strong>Plots:</strong> ${recordData.regDetails.plots.join(', ')}</div>
                        </div>
                    </div>
                    <div style="margin-bottom: 25px;">
                        <h3 style="margin: 0 0 10px; font-size: 16px; background: #f3f4f6; padding: 8px; border-left: 5px solid #f59e0b;">Mutation Details</h3>
                        <div style="font-size: 12px;">
                            <div><strong>Case Number:</strong> ${recordData.mutation.caseNo}</div>
                            <div><strong>Year:</strong> ${recordData.mutation.year}</div>
                        </div>
                    </div>
                    <!-- GPS SECTION ADDED TO PDF -->
                    <div style="margin-bottom: 25px;">
                        <h3 style="margin: 0 0 10px; font-size: 16px; background: #f3f4f6; padding: 8px; border-left: 5px solid #ef4444;">GPS Location</h3>
                        <div style="font-size: 12px;">
                            <div><strong>Latitude:</strong> ${recordData.gps.lat || 'N/A'}</div>
                            <div><strong>Longitude:</strong> ${recordData.gps.lng || 'N/A'}</div>
                        </div>
                    </div>
            `;
            await new Promise(r => setTimeout(r, 500));
            return new Promise((resolve, reject) => {
                html2canvas(tempContainer.firstElementChild, { scale: 2 }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
                    const imgWidth = 210; const pageHeight = 295;
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    let heightLeft = imgHeight; let position = 0;
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                    while(heightLeft > 0) {
                        position = heightLeft - imgHeight; pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }
                    tempContainer.innerHTML = '';
                    resolve(pdf.output('blob'));
                }).catch(err => {
                    tempContainer.innerHTML = ''; reject(err);
                });
            });
        }

        function generatePreview() {
            if(!registrationData) return;
            const container = document.getElementById('previewContent');
            const gps = registrationData.gps || {};
            
            container.innerHTML = `
                <div class="text-center mb-6 border-b pb-4">
                    <h1 class="text-2xl font-bold text-blue-800">Record Preview</h1>
                    <p class="text-sm text-gray-500">Date: ${registrationData.regDetails.date}</p>
                </div>
                <div class="preview-section">
                    <div class="preview-title">Registration Details</div>
                    <div class="grid grid-cols-2 gap-2">
                        <div><strong>Deed No:</strong> ${registrationData.regDetails.deedNo}</div>
                        <div><strong>Mauza:</strong> ${registrationData.regDetails.mauza}</div>
                        <div><strong>Block:</strong> ${registrationData.regDetails.block}</div>
                        <div><strong>Area:</strong> ${registrationData.regDetails.area}</div>
                    </div>
                </div>
                <div class="preview-section">
                    <div class="preview-title">Mutation Details</div>
                    <div class="grid grid-cols-2 gap-2">
                        <div><strong>Case No:</strong> ${registrationData.mutation.caseNo}</div>
                        <div><strong>Year:</strong> ${registrationData.mutation.year}</div>
                    </div>
                </div>
                <!-- GPS SECTION ADDED TO PREVIEW WITH MAP BUTTON -->
                <div class="preview-section">
                    <div class="preview-title">GPS Location</div>
                    <div class="flex flex-col gap-2">
                        <div class="flex gap-4">
                            <div><strong>Lat:</strong> <span id="prev-lat">${gps.lat || '-'}</span></div>
                            <div><strong>Lng:</strong> <span id="prev-lng">${gps.lng || '-'}</span></div>
                        </div>
                        ${gps.lat && gps.lng ? 
                            `<button onclick="window.openMap('${gps.lat}', '${gps.lng}')" class="mt-2 bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 text-sm w-fit">
                                <i class="fas fa-map-marked-alt mr-1"></i> Go to Google Map
                             </button>` 
                            : '<span class="text-xs text-gray-400 italic">No location data available</span>'}
                    </div>
                </div>
                <div class="preview-section">
                    <div class="preview-title">Seller(s)</div>
                    ${registrationData.sellers.map(s => `<p class="bg-gray-50 p-2 rounded mb-1">${s.name} (Father: ${s.father})</p>`).join('')}
                </div>
                <div class="preview-section">
                    <div class="preview-title">Purchaser(s)</div>
                    ${registrationData.purchasers.map(p => `<p class="bg-gray-50 p-2 rounded mb-1">${p.name} (Father: ${p.father})</p>`).join('')}
                </div>
            `;
        }

        function downloadReportPDF() {
            if(!registrationData) return showNotification('No data', 'error');
            generatePdfBlob(registrationData).then(blob => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `Report_${registrationData.regDetails.deedNo}.pdf`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
                showNotification('PDF Downloaded', 'success');
            }).catch(err => showNotification('Error', 'error'));
        }

        // --- GOOGLE DRIVE SYNC LOGIC ---
        async function syncRecord() {
            let data = registrationData;
            if(!data) {
                const req = document.querySelectorAll('#registrationForm [required]');
                let v=true; req.forEach(f=>{if(!f.value)v=false;}); 
                if(!v) return showNotification('Fill fields', 'error');
                data = collectFormData();
            }
            if(!isDriveConnected) return showNotification('Connect Drive', 'error');
            const btn = document.activeElement;
            const orig = btn.innerHTML;
            btn.disabled = true; btn.innerHTML = `<span class="loader mr-2"></span> Syncing...`;

            try {
                showNotification('Creating Folder...', 'info');
                const cleanName = (str) => str.replace(/[\/\\?%*:|"<>]/g, '-').trim();
                let folderName = `${cleanName(data.sellers[0]?.name)} TO ${cleanName(data.purchasers[0]?.name)} (${data.regDetails.deedNo})`;
                
                // 1. Create Record Folder
                let folderId = await findOrCreateFolder(folderName, TARGET_DRIVE_FOLDER_ID);

                // 2. Generate and Upload Report PDF to Folder
                showNotification('Generating Report...', 'info');
                const pdfBlob = await generatePdfBlob(data);
                await uploadFileToDrive(pdfBlob, `Report_${data.regDetails.deedNo}.pdf`, folderId, 'application/pdf');
                
                // 3. Move User Uploaded Files to Folder
                showNotification('Organizing Files...', 'info');
                for (const doc of uploadedFiles) {
                    // PATCH request to update parents
                    const url = `https://www.googleapis.com/drive/v3/files/${doc.id}?addParents=${folderId}&removeParents=root`;
                    await driveRequest(url, 'PATCH');
                }

                data.driveFolderId = folderId;
                data.driveSyncedAt = new Date().toISOString();

                // Update Firestore
                const idToUse = currentRecordId || registrationData.id;
                if(idToUse) {
                    await updateDoc(doc(db, "records", idToUse), {
                        driveFolderId: data.driveFolderId,
                        driveSyncedAt: data.driveSyncedAt,
                        documents: uploadedFiles 
                    });
                }

                showNotification('Sync Complete!', 'success');
                if(!currentRecordId) { 
                    // Reset if it was a new record sync
                    resetFormForFreshEntry();
                    switchTab('records'); 
                    loadRecords(); 
                }
                else { 
                    loadRecords(); 
                    window.editRecord(idToUse); 
                }

            } catch (error) {
                console.error(error);
                showNotification('Sync Failed: '+error.message, 'error');
            } finally {
                btn.innerHTML = orig; btn.disabled = false;
            }
        }

        // FIX: Robust Fetch Implementation for Folder Search/Create
        async function findOrCreateFolder(name, parentId) {
            const query = `name='${name}' and '${parentId}' in parents and trashed=false`;
            try {
                // Search for folder
                const searchUrl = `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&spaces=drive&fields=files(id,name)`;
                const response = await driveRequest(searchUrl, 'GET');
                const data = await response.json();
                
                if (data.files && data.files.length > 0) {
                    return data.files[0].id;
                }
            } catch(e) {
                console.warn("Search failed or no folder found", e);
                // Continue to create
            }

            // Create folder
            const meta = { name: name, mimeType: 'application/vnd.google-apps.folder', parents: [parentId] };
            const createUrl = 'https://www.googleapis.com/drive/v3/files?fields=id';
            const createResponse = await driveRequest(createUrl, 'POST', JSON.stringify(meta));
            const createData = await createResponse.json();
            return createData.id;
        }

        async function uploadFileToDrive(blob, filename, folderId, mimeType) {
            const meta = { name: filename, parents: [folderId] };
            
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(meta)], { type: 'application/json' }));
            form.append('file', blob);

            const response = await driveRequest('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', 'POST', form);
            return await response.json();
        }

        function showNotification(msg, type) {
            const el = document.getElementById('notification');
            el.innerText = msg; el.className = `notification ${type} show`;
            setTimeout(() => el.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>